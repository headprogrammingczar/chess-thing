<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="/css/chessboard-1.0.0.min.css">
    <script src="/js/jquery-3.4.1.min.js"></script>
    <script src="/js/chessboard-1.0.0.min.js"></script>
    <script src="/js/chess.min.js"></script>
    <script>
      var chess;
      var boardObject;
      var boardDOM;
      var fishSocket;
      var fishData;
      var engineHistoryMoves = "";
      var engineHistoryDOM;
      var pgnHistoryDOM;
      // for convenience, various lookup tables for squares
      // annoyingly, bitboards and square indexes are transposed
      // because stockfish decided to write enum Square : int wrong
      var hex_digits = {
        "0": 0,
        "1": 1,
        "2": 2,
        "3": 3,
        "4": 4,
        "5": 5,
        "6": 6,
        "7": 7,
        "8": 8,
        "9": 9,
        "a": 10,
        "b": 11,
        "c": 12,
        "d": 13,
        "e": 14,
        "f": 15,
      };
      var bitboard_squares = [
        "a1", "a2", "a3", "a4", "a5", "a6", "a7", "a8",
        "b1", "b2", "b3", "b4", "b5", "b6", "b7", "b8",
        "c1", "c2", "c3", "c4", "c5", "c6", "c7", "c8",
        "d1", "d2", "d3", "d4", "d5", "d6", "d7", "d8",
        "e1", "e2", "e3", "e4", "e5", "e6", "e7", "e8",
        "f1", "f2", "f3", "f4", "f5", "f6", "f7", "f8",
        "g1", "g2", "g3", "g4", "g5", "g6", "g7", "g8",
        "h1", "h2", "h3", "h4", "h5", "h6", "h7", "h8",
      ];
      var square_to_index = {};
      var index_to_square = [
        "a1", "b1", "c1", "d1", "e1", "f1", "g1", "h1",
        "a2", "b2", "c2", "d2", "e2", "f2", "g2", "h2",
        "a3", "b3", "c3", "d3", "e3", "f3", "g3", "h3",
        "a4", "b4", "c4", "d4", "e4", "f4", "g4", "h4",
        "a5", "b5", "c5", "d5", "e5", "f5", "g5", "h5",
        "a6", "b6", "c6", "d6", "e6", "f6", "g6", "h6",
        "a7", "b7", "c7", "d7", "e7", "f7", "g7", "h7",
        "a8", "b8", "c8", "d8", "e8", "f8", "g8", "h8",
      ]
      index_to_square.forEach(function(val, index) {
        square_to_index[val] = index;
      });

      function bitboard_to_squares(bitboard_str) {
        // read hex string one digit at a time
        // because javascript numbers are a floaty mess
        var squares = [];
        var digitnum;
        var index = 0;
        bitboard_str.split("").reverse().forEach(function(digit) {
          digitnum = hex_digits[digit];
          for (var n = 0; n < 4; n++) {
            if (digitnum % 2 == 1) {
              squares.push(index_to_square[index]);
            }
            index++;
            digitnum = digitnum >>> 1;
          }
        });
        return squares;
      }

      function onMouseoutSquare (square, piece) {
        boardDOM.find(".square-55d63").attr("data-highlight", "");
        boardDOM.find(".square-55d63").attr("data-color", "");

        fishData.ideas.white[0].forEach(function(data, index) {
          if (data.mg < 0) {
            square = index_to_square[index];
            boardDOM.find('.square-' + square).attr("data-color", "red");
          } else if (data.mg > 0) {
            square = index_to_square[index];
            boardDOM.find('.square-' + square).attr("data-color", "green");
          }
        });
      }

      function onMouseoverSquare(square, piece) {
        index = square_to_index[square];
        data = fishData.ideas.white[0][index];
        if (data.mg != 0) {
          boardDOM.find('.square-' + square).attr("data-color", "blue");
          bitboard_to_squares(data.why).forEach(function(square) {
            boardDOM.find('.square-' + square).attr("data-highlight", "red");
          });
        }
      }

      function onDrop(source, target, piece, newPos, oldPos, orientation) {
        engineHistoryMoves += " "+source+target;
        engineHistoryDOM.val(engineHistoryMoves);
        fishSocket.send("position fen " + Chessboard.objToFen(newPos));
        fishSocket.send("eval");
      }

      $(document).ready(function() {
        chess = new Chess();
        boardObject = Chessboard('board1', {
          position: "start",
          draggable: true,
          sparePieces: true,
          onMouseoverSquare: onMouseoverSquare,
          onMouseoutSquare: onMouseoutSquare,
          onDrop: onDrop,
        });
        boardDOM = $("#board1");
        engineHistoryDOM = $("#engine-history");
        engineHistoryDOM.change(function(e) {
          engineHistoryMoves = engineHistoryDOM.val();
          fishSocket.send("position startpos moves " +engineHistoryMoves);
          fishSocket.send("eval");
        });
        pgnHistoryDOM = $("#pgn-history");
        pgnHistoryDOM.change(function(e) {
          var engineMoves = "";
          chess = new Chess();
          chess.load_pgn(pgnHistoryDOM.val());
          chess.history({verbose: true}).forEach(function(move) {
            engineMoves += move.from + move.to + " ";
          });
          engineMoves.replace(/ $/, '');
          engineHistoryDOM.val(engineMoves);
          engineHistoryMoves = engineHistoryDOM.val();
          fishSocket.send("position startpos moves " +engineMoves);
          fishSocket.send("eval");
        });
        fishSocket = new WebSocket('ws://localhost:8080');
        fishSocket.addEventListener('message', function (event) {
          if (match = event.data.match(/^JSON (.*)$/)) {
            fishData = JSON.parse(match[1]);
            boardObject.position(fishData.fen);
            chess = new Chess();
            engineHistoryDOM.val().split(/ /).forEach(function(val) {
              chess.move(val, {sloppy: true});
            });
            pgnHistoryDOM.val(chess.pgn());
            onMouseoutSquare(undefined, undefined);
            console.log("new position - " + fishData.fen);
          }
        });
        fishSocket.addEventListener('open', function (event) {
          fishSocket.send("position " + boardObject.fen());
          fishSocket.send("eval");
        });
      });
    </script>
    <style>
      .black-3c85d[data-highlight=red] {
        background-image: url(/img/highlight-red.png);
        background-size: 100%;
      }
      .white-1e1d7[data-highlight=red] {
        background-image: url(/img/highlight-red.png);
        background-size: 100%;
      }
      .black-3c85d[data-highlight=green] {
        background-image: url(/img/highlight-green.png);
        background-size: 100%;
      }
      .white-1e1d7[data-highlight=green] {
        background-image: url(/img/highlight-green.png);
        background-size: 100%;
      }
      .black-3c85d[data-color=blue] {
        background-color: #595979;
      }
      .white-1e1d7[data-color=blue] {
        background-color: #9999b9;
      }
      .black-3c85d[data-color=green] {
        background-color: #597959;
      }
      .white-1e1d7[data-color=green] {
        background-color: #99b999;
      }
      .black-3c85d[data-color=red] {
        background-color: #8f4040;
      }
      .white-1e1d7[data-color=red] {
        background-color: #cf8080;
      }
    </style>
  </head>
  <body>
    <div id="board1" style="width: 400px" data-squares='{"b1": {"green": ["b1"], "blue": ["d2"], "red": ["c3", "b1"]}}'></div>
    <div id="idea-0-details">
      <h1>Mobility</h1>
      <p>Mobile pieces have more useful squares they can move to. Mobility is denied by friendly pawns, friendly king and queen, and spaces that are controlled by enemy pawns.</p>
    </div>
    <textarea id="engine-history" placeholder="engine-history"></textarea>
    <textarea id="pgn-history" placeholder="pgn-history"></textarea>
    <textarea id="fen-string" placeholder="fen-string"></textarea>
  </body>
</html>
